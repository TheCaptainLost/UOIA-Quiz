<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Ausbildungs-Quiz Umweltverwaltung (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f4f6f8;
      --card-bg: #ffffff;
      --primary: #005a9c;
      --primary-light: #e3f1ff;
      --danger: #c62828;
      --success: #2e7d32;
      --text: #222222;
      --muted: #666666;
      --border: #d0d7de;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
    }
    .app { max-width: 800px; width: 100%; margin: 24px; }
    .card {
      background: var(--card-bg); border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px 20px 16px 20px;
    }
    h1 { font-size: 1.4rem; margin: 0 0 8px 0; color: var(--primary); }
    .subtitle { font-size: 0.9rem; color: var(--muted); margin-bottom: 16px; }
    .config {
      margin-bottom: 16px; padding: 10px 12px;
      border-radius: 8px; background: #f8fafc; border: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .config-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .config label { font-weight: 600; margin-right: 4px; }
    .config select { font-size: 0.85rem; }
    .status-bar {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.85rem; margin-bottom: 12px; color: var(--muted);
    }
    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      font-size: 0.75rem; background: var(--primary-light); color: var(--primary);
    }
    .question-text { font-weight: 600; margin-bottom: 8px; }
    .hint { font-size: 0.8rem; color: var(--muted); margin-bottom: 10px; }
    .options { list-style: none; padding: 0; margin: 0 0 10px 0; }
    .option {
      border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 10px; margin-bottom: 8px; display: flex; align-items: center;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .option input { margin-right: 8px; }
    .option.correct { background: #e8f5e9; border-color: var(--success); }
    .option.incorrect { background: #ffebee; border-color: var(--danger); }
    .option.disabled { opacity: 0.8; }
    .explanation {
      font-size: 0.85rem; margin-top: 6px; padding: 8px 10px;
      border-radius: 8px; background: #f8fafc; border: 1px solid var(--border);
    }
    .explanation strong { display: block; margin-bottom: 4px; }
    .buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    button {
      border-radius: 999px; border: none; padding: 8px 16px;
      font-size: 0.9rem; cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #ffffff; }
    .btn-primary:disabled { opacity: 0.6; cursor: default; }
    .btn-secondary { background: #e0e0e0; color: #222; }
    .feedback { font-size: 0.9rem; font-weight: 600; }
    .feedback.ok { color: var(--success); }
    .feedback.bad { color: var(--danger); }
    .summary { margin-top: 10px; font-size: 0.85rem; color: var(--muted); }
    .small { font-size: 0.8rem; color: var(--muted); }
    @media (max-width: 600px) {
      .app { margin: 12px; }
      .buttons { flex-direction: column; align-items: stretch; gap: 8px; }
      button { width: 100%; text-align: center; }
      .config-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Ausbildungs-Quiz Umweltverwaltung</h1>
    <div class="subtitle">
      Fragen stammen aus einer zentralen CSV-Datei (UTF-8) auf dem Server.
    </div>

    <div class="config">
      <div class="config-row">
        <label for="topic-select">Themengebiet:</label>
        <select id="topic-select" disabled>
          <option value="__all__">– Fragen werden geladen –</option>
        </select>
        <span id="load-status" class="small">Lade Fragen ...</span>
      </div>
      <div class="small" style="margin-top:6px;">
        Dateiname der Fragenliste (im selben Ordner): <strong>QuizFragen_UTF8.csv</strong>.
      </div>
    </div>

    <div class="status-bar">
      <div id="question-counter">Keine Fragen geladen.</div>
      <div>
        <span id="question-type" class="badge">–</span>
        <span style="margin-left: 8px;">Punkte: <strong id="score">0</strong></span>
      </div>
    </div>

    <div id="quiz">
      <div class="small">Fragen werden geladen ...</div>
    </div>

    <div class="buttons">
      <span id="feedback" class="feedback"></span>
      <div>
        <button id="check-btn" class="btn-primary" disabled>Antwort prüfen</button>
        <button id="next-btn" class="btn-secondary" style="display:none;">Nächste Frage</button>
      </div>
    </div>

    <div id="summary" class="summary"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  var CSV_FILE = "QuizFragen_UTF8.csv"; // zentrale Fragenliste

  var allQuestions = [];
  var filteredQuestions = [];
  var currentIndex = 0;
  var score = 0;
  var hasChecked = false;

  var quizContainer = document.getElementById("quiz");
  var questionCounterEl = document.getElementById("question-counter");
  var questionTypeEl = document.getElementById("question-type");
  var scoreEl = document.getElementById("score");
  var feedbackEl = document.getElementById("feedback");
  var summaryEl = document.getElementById("summary");
  var checkBtn = document.getElementById("check-btn");
  var nextBtn = document.getElementById("next-btn");
  var loadStatusEl = document.getElementById("load-status");
  var topicSelect = document.getElementById("topic-select");

  // CSV vom Server laden
  function loadCsvFromServer() {
    loadStatusEl.textContent = "Fragen werden vom Server geladen ...";
    fetch(CSV_FILE + "?t=" + Date.now()) // Cache vermeiden
      .then(function(response) {
        if (!response.ok) throw new Error("HTTP " + response.status);
        return response.text();
      })
      .then(function(csvText) {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            allQuestions = convertCsvToQuestions(results.data);
            if (allQuestions.length === 0) {
              loadStatusEl.textContent = "Keine gültigen Fragen gefunden. Bitte CSV prüfen.";
              quizContainer.innerHTML = '<div class="small">Keine Fragen geladen.</div>';
              return;
            }
            buildTopicSelect(allQuestions);
            topicSelect.disabled = false;
            loadStatusEl.textContent = "Fragen erfolgreich geladen: " + allQuestions.length;
            applyTopicFilter();
            startQuiz();
          },
          error: function(err) {
            console.error(err);
            loadStatusEl.textContent = "Fehler beim Einlesen der CSV.";
          }
        });
      })
      .catch(function(err) {
        console.error(err);
        loadStatusEl.textContent = "CSV konnte nicht geladen werden (" + err.message + ").";
        quizContainer.innerHTML = '<div class="small">Fehler beim Laden der Fragenliste.</div>';
      });
  }

  function convertCsvToQuestions(rows) {
    var questions = [];
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var frage = (row.Frage || "").trim();
      var typRaw = (row.Typ || "").trim().toLowerCase();
      var thema = (row.Thema || "").trim();
      var a = (row.AntwortA || "").trim();
      var b = (row.AntwortB || "").trim();
      var c = (row.AntwortC || "").trim();
      var d = (row.AntwortD || "").trim();
      var richtigRaw = (row.Richtig || "").trim();
      var erk = (row.Erklaerung || "").trim();

      if (!frage || !a || !b || !c || !d || !richtigRaw) continue;

      var type = (typRaw === "multi") ? "multi" : "single";
      var correct = parseCorrect(richtigRaw);
      if (correct.length === 0) continue;

      questions.push({
        topic: thema || "Allgemein",
        text: frage,
        type: type,
        options: [a, b, c, d],
        correct: correct,
        explanation: erk || ""
      });
    }
    return questions;
  }

  function parseCorrect(text) {
    var parts = text.split(/[;,]/);
    var result = [];
    for (var i = 0; i < parts.length; i++) {
      var p = (parts[i] || "").trim();
      if (!p) continue;
      var upper = p.toUpperCase();
      var index = -1;
      if (upper === "A") index = 0;
      else if (upper === "B") index = 1;
      else if (upper === "C") index = 2;
      else if (upper === "D") index = 3;
      else {
        var num = parseInt(p, 10);
        if (!isNaN(num) && num >= 1 && num <= 4) index = num - 1;
      }
      if (index >= 0 && index <= 3 && result.indexOf(index) === -1) result.push(index);
    }
    return result;
  }

  function buildTopicSelect(questions) {
    var topics = [];
    for (var i = 0; i < questions.length; i++) {
      var t = questions[i].topic || "Allgemein";
      if (topics.indexOf(t) === -1) topics.push(t);
    }
    topicSelect.innerHTML = "";
    var optAll = document.createElement("option");
    optAll.value = "__all__";
    optAll.textContent = "Alle Themen";
    topicSelect.appendChild(optAll);
    topics.sort();
    for (var j = 0; j < topics.length; j++) {
      var topic = topics[j];
      var opt = document.createElement("option");
      opt.value = topic;
      opt.textContent = topic;
      topicSelect.appendChild(opt);
    }
  }

  topicSelect.addEventListener("change", function () {
    applyTopicFilter();
    startQuiz();
  });

  function applyTopicFilter() {
    var selectedTopic = topicSelect.value;
    if (selectedTopic === "__all__") {
      filteredQuestions = allQuestions.slice();
    } else {
      filteredQuestions = [];
      for (var i = 0; i < allQuestions.length; i++) {
        if (allQuestions[i].topic === selectedTopic) {
          filteredQuestions.push(allQuestions[i]);
        }
      }
    }
  }

  function startQuiz() {
    if (!filteredQuestions || filteredQuestions.length === 0) {
      quizContainer.innerHTML = '<div class="small">Für dieses Themengebiet liegen keine Fragen vor.</div>';
      questionCounterEl.textContent = "Keine Fragen für Auswahl.";
      checkBtn.disabled = true;
      nextBtn.style.display = "none";
      return;
    }
    shuffleArray(filteredQuestions);
    currentIndex = 0;
    score = 0;
    scoreEl.textContent = "0";
    feedbackEl.textContent = "";
    summaryEl.textContent = "";
    checkBtn.disabled = false;
    nextBtn.style.display = "none";
    renderQuestion();
  }

  function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = arr[i]; arr[i] = arr[j]; arr[j] = temp;
    }
  }

  function renderQuestion() {
    if (!filteredQuestions || filteredQuestions.length === 0) {
      quizContainer.innerHTML = '<div class="small">Keine Fragen geladen.</div>';
      questionCounterEl.textContent = "Keine Fragen geladen.";
      checkBtn.disabled = true;
      return;
    }
    var q = filteredQuestions[currentIndex];
    hasChecked = false;
    feedbackEl.textContent = "";
    summaryEl.textContent = "";
    checkBtn.disabled = false;
    nextBtn.style.display = "none";

    questionCounterEl.textContent = "Frage " + (currentIndex + 1) + " von " + filteredQuestions.length + " (" + q.topic + ")";
    questionTypeEl.textContent = (q.type === "single") ? "Einfachauswahl" : "Mehrfachauswahl";
    var hintText = (q.type === "single") ? "Bitte genau eine Antwort auswählen." : "Es können mehrere Antworten richtig sein.";

    var html = '';
    html += '<div class="question-text">' + q.text + '</div>';
    html += '<div class="hint">' + hintText + '</div>';
    html += '<ul class="options">';
    var inputType = (q.type === "single") ? "radio" : "checkbox";
    for (var i = 0; i < q.options.length; i++) {
      var opt = q.options[i];
      html += '<li class="option" data-index="' + i + '">';
      html += '<input type="' + inputType + '" name="option" id="opt-' + i + '">';
      html += '<label for="opt-' + i + '">' + opt + '</label>';
      html += '</li>';
    }
    html += '</ul>';
    html += '<div id="explanation" class="explanation" style="display:none;"></div>';
    quizContainer.innerHTML = html;
  }

  function getSelectedIndices() {
    var q = filteredQuestions[currentIndex];
    var inputType = (q.type === "single") ? "radio" : "checkbox";
    var inputs = quizContainer.querySelectorAll('input[type="' + inputType + '"]');
    var selected = [];
    for (var i = 0; i < inputs.length; i++) {
      if (inputs[i].checked) selected.push(i);
    }
    return selected;
  }

  function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    var aSorted = a.slice().sort();
    var bSorted = b.slice().sort();
    for (var i = 0; i < aSorted.length; i++) {
      if (aSorted[i] !== bSorted[i]) return false;
    }
    return true;
  }

  function checkAnswer() {
    if (hasChecked) return;
    if (!filteredQuestions || filteredQuestions.length === 0) return;

    var q = filteredQuestions[currentIndex];
    var selected = getSelectedIndices();
    if (selected.length === 0) {
      feedbackEl.textContent = "Bitte mindestens eine Antwort auswählen.";
      feedbackEl.className = "feedback bad";
      return;
    }
    var optionEls = quizContainer.querySelectorAll(".option");
    for (var i = 0; i < optionEls.length; i++) {
      var optEl = optionEls[i];
      var idx = parseInt(optEl.getAttribute("data-index"), 10);
      var isCorrect = (q.correct.indexOf(idx) !== -1);
      var isSelected = (selected.indexOf(idx) !== -1);
      if (isCorrect) optEl.classList.add("correct");
      if (isSelected && !isCorrect) optEl.classList.add("incorrect");
      optEl.classList.add("disabled");
      var input = optEl.querySelector("input");
      if (input) input.disabled = true;
    }
    var isAllCorrect = arraysEqual(selected, q.correct);
    if (isAllCorrect) {
      score++;
      scoreEl.textContent = String(score);
      feedbackEl.textContent = "Richtig!";
      feedbackEl.className = "feedback ok";
    } else {
      feedbackEl.textContent = "Nicht ganz richtig.";
      feedbackEl.className = "feedback bad";
    }
    var explEl = document.getElementById("explanation");
    explEl.style.display = "block";
    explEl.innerHTML = "<strong>Erläuterung:</strong>" + (q.explanation || "Keine Erläuterung hinterlegt.");
    hasChecked = true;
    checkBtn.disabled = true;
    nextBtn.style.display = "inline-block";
    if (currentIndex === filteredQuestions.length - 1) {
      summaryEl.textContent = "Ende des Quiz. Ergebnis: " + score + " von " + filteredQuestions.length + " Punkten.";
    }
  }

  function nextQuestion() {
    if (currentIndex < filteredQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    }
  }

  checkBtn.addEventListener("click", checkAnswer);
  nextBtn.addEventListener("click", nextQuestion);

  // Start: CSV laden
  loadCsvFromServer();
</script>
</body>
</html>
