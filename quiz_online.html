<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Ausbildungs-Quiz Umweltverwaltung (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f4f6f8;
      --card-bg: #ffffff;
      --primary: #005a9c;
      --primary-light: #e3f1ff;
      --danger: #c62828;
      --success: #2e7d32;
      --text: #222222;
      --muted: #666666;
      --border: #d0d7de;
    }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
    }
    .app { max-width: 900px; width: 100%; margin: 24px; }
    .card {
      background: var(--card-bg); border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px 20px 16px 20px;
    }
    h1 { font-size: 1.4rem; margin: 0 0 8px 0; color: var(--primary); }
    .subtitle { font-size: 0.9rem; color: var(--muted); margin-bottom: 16px; }

    .config {
      margin-bottom: 16px; padding: 10px 12px;
      border-radius: 8px; background: #f8fafc; border: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .config-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .config label { font-weight: 600; margin-right: 4px; }
    .config select { font-size: 0.85rem; }

    .status-bar {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.85rem; margin-bottom: 12px; color: var(--muted);
    }
    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      font-size: 0.75rem; background: var(--primary-light); color: var(--primary);
    }

    .question-text { font-weight: 600; margin-bottom: 8px; }
    .hint { font-size: 0.8rem; color: var(--muted); margin-bottom: 10px; }

    .options { list-style: none; padding: 0; margin: 0 0 10px 0; }
    .option {
      border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 10px; margin-bottom: 8px; display: flex; align-items: center;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .option input { margin-right: 8px; }
    .option.correct { background: #e8f5e9; border-color: var(--success); }
    .option.incorrect { background: #ffebee; border-color: var(--danger); }
    .option.disabled { opacity: 0.8; }

    .explanation {
      font-size: 0.85rem; margin-top: 6px; padding: 8px 10px;
      border-radius: 8px; background: #f8fafc; border: 1px solid var(--border);
    }
    .explanation strong { display: block; margin-bottom: 4px; }

    .rating-row {
      display: flex; align-items: center; gap: 8px;
      margin-top: 10px; margin-bottom: 4px; font-size: 0.85rem;
    }
    .icon-button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      background: #ffffff;
      cursor: pointer;
      font-size: 1rem;
    }
    .icon-button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .buttons {
      display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
    }
    button {
      border-radius: 999px; border: none; padding: 8px 16px;
      font-size: 0.9rem; cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #ffffff; }
    .btn-primary:disabled { opacity: 0.6; cursor: default; }
    .btn-secondary { background: #e0e0e0; color: #222; }
    .btn-small { padding: 4px 10px; font-size: 0.8rem; }

    .feedback { font-size: 0.9rem; font-weight: 600; }
    .feedback.ok { color: var(--success); }
    .feedback.bad { color: var(--danger); }

    .summary { margin-top: 10px; font-size: 0.85rem; color: var(--muted); }
    .small { font-size: 0.8rem; color: var(--muted); }

    details.new-question {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }
    details.new-question summary {
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .new-question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .new-question-grid label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    .new-question-grid input,
    .new-question-grid select,
    .new-question-grid textarea {
      width: 100%;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    textarea { resize: vertical; min-height: 40px; }

    @media (max-width: 600px) {
      .app { margin: 12px; }
      .buttons { flex-direction: column; align-items: stretch; gap: 8px; }
      button { width: 100%; text-align: center; }
      .config-row { flex-direction: column; align-items: flex-start; }
      .rating-row { flex-wrap: wrap; align-items: center; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Ausbildungs-Quiz Umweltverwaltung</h1>
    <div class="subtitle">
      Fragen stammen aus einer zentralen CSV-Datei (UTF-8) auf dem Server.
    </div>

    <div class="config">
      <div class="config-row">
        <label for="topic-select">Themengebiet:</label>
        <select id="topic-select" disabled>
          <option value="__all__">‚Äì Fragen werden geladen ‚Äì</option>
        </select>
        <span id="load-status" class="small">Lade Fragen ...</span>
      </div>
      <div class="small" style="margin-top:6px;">
        Dateiname der Fragenliste (im selben Ordner): <strong>QuizFragen_UTF8.csv</strong>.
      </div>
    </div>

    <div class="status-bar">
      <div id="question-counter">Keine Fragen geladen.</div>
      <div>
        <span id="question-type" class="badge">‚Äì</span>
        <span style="margin-left: 8px;">Punkte: <strong id="score">0</strong></span>
      </div>
    </div>

    <div id="quiz">
      <div class="small">Fragen werden geladen ...</div>
    </div>

    <!-- Bewertungszeile -->
    <div class="rating-row">
      <span class="small">Frage bewerten:</span>
      <button id="thumb-up" class="icon-button" title="Frage ist gut" disabled>üëç</button>
      <button id="thumb-down" class="icon-button" title="Frage √ºberarbeiten" disabled>üëé</button>
      <span id="rating-status" class="small"></span>
    </div>

    <div class="buttons">
      <span id="feedback" class="feedback"></span>
      <div style="display:flex; gap:6px;">
        <button id="download-ratings" class="btn-secondary btn-small" type="button">
          Bewertungen als CSV
        </button>
        <button id="check-btn" class="btn-primary" disabled>Antwort pr√ºfen</button>
        <button id="next-btn" class="btn-secondary" style="display:none;">N√§chste Frage</button>
      </div>
    </div>

    <div id="summary" class="summary"></div>

    <!-- Neue-Frage-Formular -->
    <details class="new-question">
      <summary>Neue Frage vorschlagen / in den Pool aufnehmen</summary>
      <div class="small" style="margin-bottom:6px;">
        Vorschl√§ge werden lokal gesammelt und k√∂nnen als CSV heruntergeladen und in Excel √ºbernommen werden.
      </div>
      <div class="new-question-grid">
        <div>
          <label for="new-topic">Thema</label>
          <select id="new-topic">
            <option value="BImSchG">BImSchG</option>
            <option value="VwVfG">VwVfG</option>
            <option value="KrWG">KrWG</option>
            <option value="WHG">WHG</option>
          </select>
        </div>
        <div>
          <label for="new-type">Fragentyp</label>
          <select id="new-type">
            <option value="single">Einfachauswahl</option>
            <option value="multi">Mehrfachauswahl</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="new-question-text">Frage</label>
          <textarea id="new-question-text" placeholder="Fragestellung"></textarea>
        </div>
        <div>
          <label for="new-answer-a">Antwort A</label>
          <input id="new-answer-a" type="text">
        </div>
        <div>
          <label for="new-answer-b">Antwort B</label>
          <input id="new-answer-b" type="text">
        </div>
        <div>
          <label for="new-answer-c">Antwort C</label>
          <input id="new-answer-c" type="text">
        </div>
        <div>
          <label for="new-answer-d">Antwort D</label>
          <input id="new-answer-d" type="text">
        </div>
        <div>
          <label for="new-correct">Richtige Antwort(en)</label>
          <input id="new-correct" type="text" placeholder="A oder A;C (nur A‚ÄìD)">
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="new-expl">Erl√§uterung</label>
          <textarea id="new-expl" placeholder="Kurzbegr√ºndung / Hinweis"></textarea>
        </div>
      </div>
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <button id="add-suggestion" type="button" class="btn-secondary btn-small">
          Frage zum Vorschlag-Pool hinzuf√ºgen
        </button>
        <button id="download-suggestions" type="button" class="btn-secondary btn-small">
          Vorschl√§ge als CSV
        </button>
        <span id="suggestion-status" class="small"></span>
      </div>
    </details>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  var CSV_FILE = "QuizFragen_UTF8.csv"; // zentrale Fragenliste

  var allQuestions = [];
  var filteredQuestions = [];
  var currentIndex = 0;
  var score = 0;
  var hasChecked = false;

  // Bewertungen & Vorschl√§ge
  var ratings = [];            // {topic, text, rating, timestamp}
  var suggestedQuestions = []; // Objekt mit allen Feldern

  var quizContainer = document.getElementById("quiz");
  var questionCounterEl = document.getElementById("question-counter");
  var questionTypeEl = document.getElementById("question-type");
  var scoreEl = document.getElementById("score");
  var feedbackEl = document.getElementById("feedback");
  var summaryEl = document.getElementById("summary");
  var checkBtn = document.getElementById("check-btn");
  var nextBtn = document.getElementById("next-btn");
  var loadStatusEl = document.getElementById("load-status");
  var topicSelect = document.getElementById("topic-select");

  var thumbUpBtn = document.getElementById("thumb-up");
  var thumbDownBtn = document.getElementById("thumb-down");
  var ratingStatusEl = document.getElementById("rating-status");
  var downloadRatingsBtn = document.getElementById("download-ratings");

  var newTopicEl = document.getElementById("new-topic");
  var newTypeEl = document.getElementById("new-type");
  var newQuestionTextEl = document.getElementById("new-question-text");
  var newAnswerAEl = document.getElementById("new-answer-a");
  var newAnswerBEl = document.getElementById("new-answer-b");
  var newAnswerCEl = document.getElementById("new-answer-c");
  var newAnswerDEl = document.getElementById("new-answer-d");
  var newCorrectEl = document.getElementById("new-correct");
  var newExplEl = document.getElementById("new-expl");
  var addSuggestionBtn = document.getElementById("add-suggestion");
  var downloadSuggestionsBtn = document.getElementById("download-suggestions");
  var suggestionStatusEl = document.getElementById("suggestion-status");

  // CSV vom Server laden
  function loadCsvFromServer() {
    loadStatusEl.textContent = "Fragen werden vom Server geladen ...";
    fetch(CSV_FILE + "?t=" + Date.now())
      .then(function(response) {
        if (!response.ok) throw new Error("HTTP " + response.status);
        return response.text();
      })
      .then(function(csvText) {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            allQuestions = convertCsvToQuestions(results.data);
            if (allQuestions.length === 0) {
              loadStatusEl.textContent = "Keine g√ºltigen Fragen gefunden. Bitte CSV pr√ºfen.";
              quizContainer.innerHTML = '<div class="small">Keine Fragen geladen.</div>';
              return;
            }
            buildTopicSelect(allQuestions);
            topicSelect.disabled = false;
            loadStatusEl.textContent = "Fragen erfolgreich geladen: " + allQuestions.length;
            applyTopicFilter();
            startQuiz();
          },
          error: function(err) {
            console.error(err);
            loadStatusEl.textContent = "Fehler beim Einlesen der CSV.";
          }
        });
      })
      .catch(function(err) {
        console.error(err);
        loadStatusEl.textContent = "CSV konnte nicht geladen werden (" + err.message + ").";
        quizContainer.innerHTML = '<div class="small">Fehler beim Laden der Fragenliste.</div>';
      });
  }

  function convertCsvToQuestions(rows) {
    var questions = [];
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var frage = (row.Frage || "").trim();
      var typRaw = (row.Typ || "").trim().toLowerCase();
      var thema = (row.Thema || "").trim();
      var a = (row.AntwortA || "").trim();
      var b = (row.AntwortB || "").trim();
      var c = (row.AntwortC || "").trim();
      var d = (row.AntwortD || "").trim();
      var richtigRaw = (row.Richtig || "").trim();
      var erk = (row.Erklaerung || "").trim();

      if (!frage || !a || !b || !c || !d || !richtigRaw) continue;

      var type = (typRaw === "multi") ? "multi" : "single";
      var correct = parseCorrect(richtigRaw);
      if (correct.length === 0) continue;

      questions.push({
        topic: thema || "Allgemein",
        text: frage,
        type: type,
        options: [a, b, c, d],
        correct: correct,
        explanation: erk || ""
      });
    }
    return questions;
  }

  function parseCorrect(text) {
    var parts = text.split(/[;,]/);
    var result = [];
    for (var i = 0; i < parts.length; i++) {
      var p = (parts[i] || "").trim();
      if (!p) continue;
      var upper = p.toUpperCase();
      var index = -1;
      if (upper === "A") index = 0;
      else if (upper === "B") index = 1;
      else if (upper === "C") index = 2;
      else if (upper === "D") index = 3;
      else {
        var num = parseInt(p, 10);
        if (!isNaN(num) && num >= 1 && num <= 4) index = num - 1;
      }
      if (index >= 0 && index <= 3 && result.indexOf(index) === -1) result.push(index);
    }
    return result;
  }

  function buildTopicSelect(questions) {
    var topics = [];
    for (var i = 0; i < questions.length; i++) {
      var t = questions[i].topic || "Allgemein";
      if (topics.indexOf(t) === -1) topics.push(t);
    }
    topicSelect.innerHTML = "";
    var optAll = document.createElement("option");
    optAll.value = "__all__";
    optAll.textContent = "Alle Themen";
    topicSelect.appendChild(optAll);
    topics.sort();
    for (var j = 0; j < topics.length; j++) {
      var topic = topics[j];
      var opt = document.createElement("option");
      opt.value = topic;
      opt.textContent = topic;
      topicSelect.appendChild(opt);
    }
  }

  topicSelect.addEventListener("change", function () {
    applyTopicFilter();
    startQuiz();
  });

  function applyTopicFilter() {
    var selectedTopic = topicSelect.value;
    if (selectedTopic === "__all__") {
      filteredQuestions = allQuestions.slice();
    } else {
      filteredQuestions = [];
      for (var i = 0; i < allQuestions.length; i++) {
        if (allQuestions[i].topic === selectedTopic) {
          filteredQuestions.push(allQuestions[i]);
        }
      }
    }
  }

  function startQuiz() {
    if (!filteredQuestions || filteredQuestions.length === 0) {
      quizContainer.innerHTML = '<div class="small">F√ºr dieses Themengebiet liegen keine Fragen vor.</div>';
      questionCounterEl.textContent = "Keine Fragen f√ºr Auswahl.";
      checkBtn.disabled = true;
      nextBtn.style.display = "none";
      thumbUpBtn.disabled = true;
      thumbDownBtn.disabled = true;
      return;
    }
    shuffleArray(filteredQuestions);
    currentIndex = 0;
    score = 0;
    scoreEl.textContent = "0";
    feedbackEl.textContent = "";
    summaryEl.textContent = "";
    checkBtn.disabled = false;
    nextBtn.style.display = "none";
    renderQuestion();
  }

  function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = arr[i]; arr[i] = arr[j]; arr[j] = temp;
    }
  }

  function renderQuestion() {
    if (!filteredQuestions || filteredQuestions.length === 0) {
      quizContainer.innerHTML = '<div class="small">Keine Fragen geladen.</div>';
      questionCounterEl.textContent = "Keine Fragen geladen.";
      checkBtn.disabled = true;
      thumbUpBtn.disabled = true;
      thumbDownBtn.disabled = true;
      ratingStatusEl.textContent = "";
      return;
    }
    var q = filteredQuestions[currentIndex];
    hasChecked = false;
    feedbackEl.textContent = "";
    summaryEl.textContent = "";
    checkBtn.disabled = false;
    nextBtn.style.display = "none";
    thumbUpBtn.disabled = false;
    thumbDownBtn.disabled = false;
    ratingStatusEl.textContent = "";

    questionCounterEl.textContent =
      "Frage " + (currentIndex + 1) + " von " + filteredQuestions.length + " (" + q.topic + ")";
    questionTypeEl.textContent = (q.type === "single") ? "Einfachauswahl" : "Mehrfachauswahl";
    var hintText = (q.type === "single") ?
      "Bitte genau eine Antwort ausw√§hlen." :
      "Es k√∂nnen mehrere Antworten richtig sein.";

    var html = '';
    html += '<div class="question-text">' + q.text + '</div>';
    html += '<div class="hint">' + hintText + '</div>';
    html += '<ul class="options">';
    var inputType = (q.type === "single") ? "radio" : "checkbox";
    for (var i = 0; i < q.options.length; i++) {
      var opt = q.options[i];
      html += '<li class="option" data-index="' + i + '">';
      html += '<input type="' + inputType + '" name="option" id="opt-' + i + '">';
      html += '<label for="opt-' + i + '">' + opt + '</label>';
      html += '</li>';
    }
    html += '</ul>';
    html += '<div id="explanation" class="explanation" style="display:none;"></div>';
    quizContainer.innerHTML = html;
  }

  function getSelectedIndices() {
    var q = filteredQuestions[currentIndex];
    var inputType = (q.type === "single") ? "radio" : "checkbox";
    var inputs = quizContainer.querySelectorAll('input[type="' + inputType + '"]');
    var selected = [];
    for (var i = 0; i < inputs.length; i++) {
      if (inputs[i].checked) selected.push(i);
    }
    return selected;
  }

  function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    var aSorted = a.slice().sort();
    var bSorted = b.slice().sort();
    for (var i = 0; i < aSorted.length; i++) {
      if (aSorted[i] !== bSorted[i]) return false;
    }
    return true;
  }

  function checkAnswer() {
    if (hasChecked) return;
    if (!filteredQuestions || filteredQuestions.length === 0) return;

    var q = filteredQuestions[currentIndex];
    var selected = getSelectedIndices();
    if (selected.length === 0) {
      feedbackEl.textContent = "Bitte mindestens eine Antwort ausw√§hlen.";
      feedbackEl.className = "feedback bad";
      return;
    }
    var optionEls = quizContainer.querySelectorAll(".option");
    for (var i = 0; i < optionEls.length; i++) {
      var optEl = optionEls[i];
      var idx = parseInt(optEl.getAttribute("data-index"), 10);
      var isCorrect = (q.correct.indexOf(idx) !== -1);
      var isSelected = (selected.indexOf(idx) !== -1);
      if (isCorrect) optEl.classList.add("correct");
      if (isSelected && !isCorrect) optEl.classList.add("incorrect");
      optEl.classList.add("disabled");
      var input = optEl.querySelector("input");
      if (input) input.disabled = true;
    }
    var isAllCorrect = arraysEqual(selected, q.correct);
    if (isAllCorrect) {
      score++;
      scoreEl.textContent = String(score);
      feedbackEl.textContent = "Richtig!";
      feedbackEl.className = "feedback ok";
    } else {
      feedbackEl.textContent = "Nicht ganz richtig.";
      feedbackEl.className = "feedback bad";
    }
    var explEl = document.getElementById("explanation");
    explEl.style.display = "block";
    explEl.innerHTML = "<strong>Erl√§uterung:</strong>" +
      (q.explanation || "Keine Erl√§uterung hinterlegt.");
    hasChecked = true;
    checkBtn.disabled = true;
    nextBtn.style.display = "inline-block";
    if (currentIndex === filteredQuestions.length - 1) {
      summaryEl.textContent =
        "Ende des Quiz. Ergebnis: " + score + " von " + filteredQuestions.length + " Punkten.";
    }
  }

  function nextQuestion() {
    if (currentIndex < filteredQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    }
  }

  checkBtn.addEventListener("click", checkAnswer);
  nextBtn.addEventListener("click", nextQuestion);

  // --- Bewertung (Daumen hoch / runter) ---

  function handleRating(kind) {
    if (!filteredQuestions || filteredQuestions.length === 0) return;
    var q = filteredQuestions[currentIndex];
    var now = new Date().toISOString();

    var found = false;
    for (var i = 0; i < ratings.length; i++) {
      if (ratings[i].topic === q.topic && ratings[i].text === q.text) {
        ratings[i].rating = (kind === "up" ? "like" : "dislike");
        ratings[i].timestamp = now;
        found = true;
        break;
      }
    }
    if (!found) {
      ratings.push({
        topic: q.topic,
        text: q.text,
        rating: (kind === "up" ? "like" : "dislike"),
        timestamp: now
      });
    }

    ratingStatusEl.textContent =
      "Bewertung gespeichert (" + (kind === "up" ? "Daumen hoch" : "Daumen runter") + ").";
  }

  thumbUpBtn.addEventListener("click", function () { handleRating("up"); });
  thumbDownBtn.addEventListener("click", function () { handleRating("down"); });

  function csvEscape(value) {
    if (value == null) return "";
    var str = String(value);
    if (str.indexOf('"') >= 0 || str.indexOf(';') >= 0 || str.indexOf('\n') >= 0 || str.indexOf('\r') >= 0) {
      str = '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
  }

  function downloadRatingsCsv() {
    if (!ratings.length) {
      alert("Es wurden noch keine Bewertungen abgegeben.");
      return;
    }
    var lines = [];
    lines.push("Thema;Frage;Bewertung;Zeitstempel");
    for (var i = 0; i < ratings.length; i++) {
      var r = ratings[i];
      var line = [
        csvEscape(r.topic),
        csvEscape(r.text),
        csvEscape(r.rating),
        csvEscape(r.timestamp)
      ].join(";");
      lines.push(line);
    }
    var csvContent = "\uFEFF" + lines.join("\r\n");
    var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    var dateStr = new Date().toISOString().slice(0,10);
    a.download = "QuizBewertungen_" + dateStr + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadRatingsBtn.addEventListener("click", downloadRatingsCsv);

  // --- Neue-Frage-Vorschl√§ge ---

  function addSuggestion() {
    var topic = newTopicEl.value.trim();
    var type = newTypeEl.value === "multi" ? "multi" : "single";
    var text = newQuestionTextEl.value.trim();
    var a = newAnswerAEl.value.trim();
    var b = newAnswerBEl.value.trim();
    var c = newAnswerCEl.value.trim();
    var d = newAnswerDEl.value.trim();
    var correct = newCorrectEl.value.trim().toUpperCase();
    var expl = newExplEl.value.trim();

    if (!text || !a || !b || !c || !d || !correct) {
      suggestionStatusEl.textContent = "Bitte mindestens Frage, vier Antworten und richtige Antwort(en) ausf√ºllen.";
      return;
    }

    // Eingabeformat f√ºr richtige Antworten pr√ºfen: nur A‚ÄìD, getrennt mit ;
    var pattern = /^[A-D](;[A-D])*$/;
    if (!pattern.test(correct)) {
      suggestionStatusEl.textContent =
        "Richtige Antwort(en) nur als A, B, C oder D eingeben ‚Äì bei mehreren mit Semikolon trennen (z.B. A;C).";
      return;
    }

    suggestedQuestions.push({
      topic: topic || "Allgemein",
      text: text,
      type: type,
      a: a,
      b: b,
      c: c,
      d: d,
      correct: correct,
      explanation: expl
    });

    suggestionStatusEl.textContent =
      "Frage hinzugef√ºgt. Aktuell " + suggestedQuestions.length + " Vorschlag/Vorschl√§ge.";

    newQuestionTextEl.value = "";
    newAnswerAEl.value = "";
    newAnswerBEl.value = "";
    newAnswerCEl.value = "";
    newAnswerDEl.value = "";
    newCorrectEl.value = "";
    newExplEl.value = "";
  }

  addSuggestionBtn.addEventListener("click", addSuggestion);

  function downloadSuggestionsCsv() {
    if (!suggestedQuestions.length) {
      alert("Es wurden noch keine Fragen vorgeschlagen.");
      return;
    }
    var lines = [];
    lines.push("Thema;Frage;Typ;AntwortA;AntwortB;AntwortC;AntwortD;Richtig;Erklaerung");
    for (var i = 0; i < suggestedQuestions.length; i++) {
      var s = suggestedQuestions[i];
      var line = [
        csvEscape(s.topic),
        csvEscape(s.text),
        csvEscape(s.type),
        csvEscape(s.a),
        csvEscape(s.b),
        csvEscape(s.c),
        csvEscape(s.d),
        csvEscape(s.correct),
        csvEscape(s.explanation)
      ].join(";");
      lines.push(line);
    }
    var csvContent = "\uFEFF" + lines.join("\r\n");
    var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    var dateStr = new Date().toISOString().slice(0,10);
    a.download = "QuizFragen_Vorschlaege_" + dateStr + ".csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  downloadSuggestionsBtn.addEventListener("click", downloadSuggestionsCsv);

  // Start: CSV laden
  loadCsvFromServer();
</script>
</body>
</html>
